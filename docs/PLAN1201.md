# 이미지 만들기 기능 구현 계획 (PLAN1201)

## 개요

사용자가 상품 이미지를 업로드하고 상품명을 입력한 후, AI가 생성한 광고 문구를 선택하여 1:1 사이즈의 광고 이미지를 생성하는 기능을 구현합니다.

---

## n8n 워크플로우 분석

### 1. sapp-studio-adcopy (광고 문구 생성)
- **Webhook URL**: `https://n8n.sappstudio.kr/webhook/84e18e95-00b9-4963-9a6f-c14225a84d15`
- **인증**: Basic Auth (N8N_WEBHOOK_USER:N8N_WEBHOOK_PASSWORD)
- **요청 Body**:
  ```json
  {
    "ad_video_id": "uuid",
    "product_image_id": "uuid",
    "product_info_id": "uuid"
  }
  ```
- **응답**: 5개의 광고문구 배열
  ```json
  {
    "success": true,
    "ad_video_id": "uuid",
    "product_name": "상품명",
    "ad_copies": [
      {"id": 1, "text": "광고문구1"},
      {"id": 2, "text": "광고문구2"},
      ...
    ]
  }
  ```
- **기존 영상 만들기와 동일하게 사용 가능**

### 2. sapp-studio-adpicture (이미지 생성)
- **Webhook URL**: `https://n8n.sappstudio.kr/webhook/60fc0718-5146-48ec-a49a-ae973841687b`
- **인증**: Basic Auth
- **요청 Body**:
  ```json
  {
    "ad_video_id": "uuid",
    "product_image_id": "uuid",
    "product_info_id": "uuid",
    "selected_ad_copy": "사용자가 선택한 광고문구 텍스트"
  }
  ```
- **워크플로우 흐름**:
  1. Webhook 수신 → 즉시 응답 (`{"success": true, "message": "Workflow started"}`)
  2. `ad_videos` 테이블 상태 업데이트 (status: processing, progress_stage: ad_copy_generation)
  3. 이미지 프롬프트 생성 (Gemini 2.5 Pro) - selected_ad_copy 기반
  4. Supabase에서 최신 상품 이미지 조회
  5. 이미지 다운로드 → Base64 변환
  6. Gemini 3 Pro Image로 이미지 생성 (aspectRatio: 9:16 → **1:1로 변경 필요**)
  7. 생성된 이미지를 Supabase `images` 버킷에 업로드
  8. `ad_videos` 테이블 완료 상태 업데이트 (video_url에 이미지 URL 저장)

---

## 데이터베이스 설계

### 새 테이블: `ad_images`
기존 `ad_videos` 테이블을 활용하지 않고 별도 테이블 생성을 권장합니다:

```sql
CREATE TABLE public.ad_images (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id TEXT NOT NULL REFERENCES public.users(clerk_id) ON DELETE CASCADE,
    product_image_id UUID REFERENCES public.product_images(id) ON DELETE SET NULL,
    product_info_id UUID REFERENCES public.product_info(id) ON DELETE SET NULL,
    image_url TEXT,                    -- 생성된 이미지 URL (images 버킷)
    thumbnail_url TEXT,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
    progress_stage TEXT DEFAULT 'init' CHECK (progress_stage IN (
        'init',
        'ad_copy_generation',
        'ad_copy_selection',
        'image_generation',
        'completed',
        'failed',
        'cancelled'
    )),
    selected_ad_copy TEXT,
    error_message TEXT,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

-- 인덱스
CREATE INDEX idx_ad_images_user_id ON public.ad_images(user_id);
CREATE INDEX idx_ad_images_status ON public.ad_images(status);
CREATE INDEX idx_ad_images_is_public_created_at ON public.ad_images(created_at DESC) WHERE is_public = TRUE;

-- Realtime 활성화
ALTER PUBLICATION supabase_realtime ADD TABLE ad_images;
```

### 새 테이블: `ad_image_copies` (광고문구)
```sql
CREATE TABLE public.ad_image_copies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ad_image_id UUID NOT NULL REFERENCES public.ad_images(id) ON DELETE CASCADE,
    copy_index INTEGER NOT NULL CHECK (copy_index >= 1 AND copy_index <= 5),
    copy_text TEXT NOT NULL,
    is_selected BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(ad_image_id, copy_index)
);
```

### Storage 버킷: `images`
- **경로 구조**: `{ad_image_id}.png`
- **파일 형식**: PNG (1:1 비율)
- n8n 워크플로우에서 이미 `images` 버킷 사용 설정됨

---

## 구현 계획

### Phase 1: 데이터베이스 및 기반 구조

#### 1.1 마이그레이션 파일 생성
- `supabase/migrations/20241201000001_create_ad_images.sql`
  - ad_images 테이블 생성
  - ad_image_copies 테이블 생성
  - RLS 정책 설정
  - Realtime 활성화

#### 1.2 타입 정의
- `types/ad-image.ts` - AdImage, AdImageCopy 인터페이스
- `types/image-generation.ts` - 이미지 생성 관련 타입

#### 1.3 상수 정의
- `lib/constants/credits.ts` 수정
  - `IMAGE_GENERATION_COST = 25` 추가
- `constants/image-generation.ts` - 이미지 생성 진행 단계 상수

---

### Phase 2: 사이드바 및 라우팅

#### 2.1 사이드바 수정
- `components/sidebar.tsx` 수정
  - "영상 만들기" 위에 "이미지 만들기" 메뉴 추가
  - 아이콘: `ImagePlus` (lucide-react)
  - 경로: `/upload-image`
  - requireAuth: true

- `components/mobile-sidebar.tsx` 동일하게 수정

#### 2.2 페이지 라우트 생성
- `app/upload-image/page.tsx` - 이미지 만들기 페이지
- `app/image-generation/[id]/page.tsx` - 이미지 생성 진행 페이지
- `app/image/[id]/page.tsx` - 생성된 이미지 상세 페이지

---

### Phase 3: 이미지 만들기 업로드 페이지

#### 3.1 메인 페이지 컴포넌트
- `app/upload-image/page.tsx`
  - Suspense로 ImageUploadForm 래핑
  - ImageUploadFormSkeleton 로딩 컴포넌트

#### 3.2 업로드 폼 컴포넌트
- `components/upload-image/image-upload-form.tsx`
  - 4단계 워크플로우 (영상 만들기와 동일 구조)
  - Step 1: 이미지 업로드 (기존 ImageDropzone 재사용)
  - Step 2: 상품명 입력 (기존 ProductForm 재사용)
  - Step 3: 광고문구 선택 (ImageAdCopySelection 컴포넌트)
  - Step 4: 이미지 생성 시작

#### 3.3 광고문구 선택 컴포넌트 (재사용)
- `components/upload-image/image-ad-copy-selection.tsx`
  - 기존 `ad-copy-selection.tsx` 기반으로 구현
  - 5개 AI 생성 문구 + 1개 직접 입력 카드
  - 선택 시 하이라이트 표시
  - "다시 생성" 버튼

---

### Phase 4: Server Actions

#### 4.1 이미지 생성 관련 Actions
- `actions/image/generate-image-ad-copies.ts`
  - ad_images 레코드 생성
  - n8n adcopy webhook 호출
  - ad_image_copies에 5개 문구 저장

- `actions/image/fetch-image-ad-copies.ts`
  - adImageId로 광고문구 조회

- `actions/image/regenerate-image-ad-copies.ts`
  - 기존 문구 삭제 후 재생성

- `actions/image/select-image-ad-copy.ts`
  - 크레딧 확인 (25 크레딧)
  - 크레딧 차감
  - n8n adpicture webhook 호출 (selected_ad_copy 포함)
  - `/image-generation/{id}`로 리다이렉트

---

### Phase 5: 이미지 생성 진행 페이지

#### 5.1 진행 페이지
- `app/image-generation/[id]/page.tsx`
  - SSR로 초기 데이터 로드
  - ImageGenerationProgress 컴포넌트 렌더링

#### 5.2 진행 상태 컴포넌트
- `components/image-generation/image-generation-progress.tsx`
  - useRealtimeImage hook으로 실시간 상태 구독
  - 진행 단계 시각화 (4단계: init → ad_copy_generation → image_generation → completed)
  - 완료 시 `/image/{id}`로 이동

#### 5.3 단계 표시 컴포넌트
- `components/image-generation/image-step-indicator.tsx`
  - 이미지 생성에 맞는 4단계 표시

---

### Phase 6: 대시보드 (내 영상) 개선

#### 6.1 탭 UI 추가
- `components/dashboard/dashboard-content.tsx` 수정
  - 상단에 탭 UI 추가: "영상" | "이미지"
  - 선택된 탭에 따라 다른 데이터 표시

#### 6.2 이미지 그리드 컴포넌트
- `components/dashboard/image-grid.tsx`
  - 1:1 비율 이미지 카드 그리드
  - 반응형: 모바일(2열) → 태블릿(3열) → 데스크톱(4열)

#### 6.3 이미지 카드 컴포넌트
- `components/dashboard/image-card.tsx`
  - 1:1 aspect-ratio 적용
  - 상태 배지 (pending, processing, completed, failed)
  - 액션 버튼 (이미지 보기, 공개 토글, 삭제)

#### 6.4 Server Actions
- `actions/fetch-user-images.ts` - 사용자 이미지 목록 조회
- `actions/toggle-image-public.ts` - 이미지 공개/비공개 토글
- `actions/delete-image.ts` - 이미지 삭제

---

### Phase 7: 홈 화면 개선

#### 7.1 탭 또는 섹션 분리
- `components/home/hero-section.tsx` 수정
  - "영상" / "이미지" 탭 UI 추가
  - 또는 별도 섹션으로 분리

#### 7.2 이미지 샘플 섹션
- `components/home/sample-images-section.tsx`
  - 공개된 이미지 표시 (is_public = true)
  - 1:1 비율 그리드 레이아웃
  - 호버 시 확대 미리보기

#### 7.3 Server Action
- `actions/fetch-public-images.ts` - 공개 이미지 조회

---

### Phase 8: 이미지 상세 페이지

#### 8.1 상세 페이지
- `app/image/[id]/page.tsx`
  - 생성된 이미지 전체 화면 표시
  - 상품명, 선택된 광고문구 표시
  - 다운로드 버튼
  - 공유 버튼 (선택적)

---

## UI/UX 제안 (추가 내용)

### 이미지 만들기 페이지에 포함되면 좋을 내용

1. **예상 결과 미리보기**
   - 선택한 광고문구가 이미지에 어떻게 배치될지 간단한 프리뷰 표시
   - 실제 생성 전 느낌 파악 가능

2. **이미지 스타일 선택** (선택적)
   - "밝은/어두운", "모던/빈티지" 등 스타일 옵션
   - 현재 n8n 워크플로우에서는 지원하지 않으나 향후 확장 가능

3. **생성 소요 시간 안내**
   - 예상 소요 시간 표시 (약 30초~1분)
   - 영상보다 빠르다는 점 강조

4. **크레딧 정보 명시**
   - 현재 보유 크레딧 표시
   - "이미지 생성 시 25 크레딧 차감" 안내

### 대시보드 개선 제안

1. **필터 옵션**
   - 날짜별 필터
   - 상태별 필터 (완료/진행중/실패)

2. **정렬 옵션**
   - 최신순/오래된순
   - 상품명순

3. **일괄 작업**
   - 여러 이미지 선택 후 일괄 삭제/공개

### 홈 화면 제안

1. **영상/이미지 구분 UI**
   - 탭 방식: 깔끔하지만 한 번에 한 종류만 표시
   - 섹션 분리 방식: 스크롤로 둘 다 확인 가능 (권장)

2. **이미지 갤러리 스타일**
   - 1:1 그리드 레이아웃
   - 호버 시 상품명/광고문구 오버레이

---

## 파일 구조 요약

```
app/
├── upload-image/
│   └── page.tsx                    # 이미지 만들기 페이지
├── image-generation/
│   └── [id]/
│       └── page.tsx                # 이미지 생성 진행 페이지
├── image/
│   └── [id]/
│       └── page.tsx                # 이미지 상세 페이지
├── dashboard/
│   └── page.tsx                    # (기존) 탭 UI 추가

components/
├── upload-image/
│   ├── image-upload-form.tsx       # 이미지 업로드 폼
│   └── image-ad-copy-selection.tsx # 광고문구 선택
├── image-generation/
│   ├── image-generation-progress.tsx
│   └── image-step-indicator.tsx
├── dashboard/
│   ├── dashboard-tabs.tsx          # 영상/이미지 탭
│   ├── image-grid.tsx              # 이미지 그리드
│   └── image-card.tsx              # 이미지 카드
├── home/
│   └── sample-images-section.tsx   # 홈 이미지 섹션
└── sidebar.tsx                     # (수정) 이미지 만들기 메뉴

actions/
├── image/
│   ├── generate-image-ad-copies.ts
│   ├── fetch-image-ad-copies.ts
│   ├── regenerate-image-ad-copies.ts
│   └── select-image-ad-copy.ts
├── fetch-user-images.ts
├── fetch-public-images.ts
├── toggle-image-public.ts
└── delete-image.ts

hooks/
├── use-realtime-image.ts           # 이미지 상태 실시간 구독
└── use-image-generation-complete.ts

types/
├── ad-image.ts
└── image-generation.ts

constants/
└── image-generation.ts

supabase/migrations/
└── 20241201000001_create_ad_images.sql
```

---

## 환경 변수

기존 환경 변수 재사용:
```env
N8N_ADCOPY_WEBHOOK_URL=https://n8n.sappstudio.kr/webhook/84e18e95-00b9-4963-9a6f-c14225a84d15
N8N_ADPICTURE_WEBHOOK_URL=https://n8n.sappstudio.kr/webhook/60fc0718-5146-48ec-a49a-ae973841687b
N8N_WEBHOOK_USER=...
N8N_WEBHOOK_PASSWORD=...
```

---

## 크레딧 설정

```typescript
// lib/constants/credits.ts
export const VIDEO_GENERATION_COST = 80;
export const IMAGE_GENERATION_COST = 25;  // 추가
export const MIN_CREDITS_FOR_IMAGE = 25;  // 추가
```

---

## n8n 워크플로우 수정 필요 사항

### sapp-studio-adpicture 수정 필요:
1. **이미지 비율 변경**: 9:16 → 1:1
   - `이미지생성` 노드의 `imageConfig.aspectRatio`를 `"1:1"`로 변경

2. **테이블 참조 변경** (선택적):
   - 현재: `ad_videos` 테이블 업데이트
   - 변경: `ad_images` 테이블 업데이트
   - 또는 웹훅 요청에 `type: "image"` 파라미터 추가하여 분기 처리

---

## 구현 우선순위

1. **Phase 1**: 데이터베이스 마이그레이션 (필수 선행)
2. **Phase 2**: 사이드바 및 라우팅
3. **Phase 3**: 이미지 업로드 페이지
4. **Phase 4**: Server Actions
5. **Phase 5**: 이미지 생성 진행 페이지
6. **Phase 6**: 대시보드 탭 UI
7. **Phase 7**: 홈 화면 개선
8. **Phase 8**: 이미지 상세 페이지

---

## 주의사항

1. **n8n 워크플로우와의 호환성**:
   - 현재 워크플로우는 `ad_videos` 테이블 기준
   - `ad_images` 테이블 사용 시 워크플로우 수정 필요

2. **Storage 버킷**:
   - `images` 버킷이 이미 n8n 워크플로우에 설정됨
   - RLS 정책 확인 필요

3. **1:1 이미지 비율**:
   - n8n 워크플로우의 aspectRatio 설정 변경 필요
   - 프론트엔드 UI도 1:1 비율에 맞게 구현

4. **크레딧 차감 시점**:
   - 광고문구 선택 후 이미지 생성 시작 시점에 차감
   - 실패 시 환불 로직 필요
